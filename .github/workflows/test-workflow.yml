name: Test EPG Fetcher

on:
  # Manual trigger only for testing
  workflow_dispatch:
    inputs:
      site:
        description: 'Site to fetch from (e.g., arirang.com)'
        required: false
        default: 'arirang.com'
      days:
        description: 'Number of days to fetch'
        required: false
        default: '3'

jobs:
  test-bash-script:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Make script executable
        run: chmod +x epg-fetcher.sh
      
      - name: Test EPG fetch
        run: |
          ./epg-fetcher.sh \
            --site ${{ github.event.inputs.site }} \
            --output test-guide.xml \
            --days ${{ github.event.inputs.days }} \
            --max-connections 5
      
      - name: Verify output file was created
        run: |
          if [ -f "test-guide.xml" ]; then
            echo "✓ EPG file created successfully!"
            ls -lh test-guide.xml
            echo ""
            echo "First 20 lines of EPG:"
            head -20 test-guide.xml
          else
            echo "✗ EPG file was not created"
            exit 1
          fi
      
      - name: Upload EPG as artifact
        uses: actions/upload-artifact@v3
        with:
          name: test-epg-guide
          path: test-guide.xml
          retention-days: 1

  test-request-script:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Make script executable
        run: chmod +x request-epg.sh
      
      - name: Test request-epg.sh script
        run: |
          ./request-epg.sh \
            --site ${{ github.event.inputs.site }} \
            --output test-request-guide.xml \
            --days ${{ github.event.inputs.days }} \
            --max-connections 5
      
      - name: Verify output
        run: |
          if [ -f "test-request-guide.xml" ]; then
            echo "✓ Request script works!"
            ls -lh test-request-guide.xml
          else
            echo "✗ Request script failed"
            exit 1
          fi
      
      - name: Upload result
        uses: actions/upload-artifact@v3
        with:
          name: test-request-guide
          path: test-request-guide.xml
          retention-days: 1

  test-with-channels-file:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Make script executable
        run: chmod +x epg-fetcher.sh
      
      - name: Test with example-channels.xml
        run: |
          ./epg-fetcher.sh \
            --channels example-channels.xml \
            --output test-channels-guide.xml \
            --days 2 \
            --max-connections 3
      
      - name: Verify output
        run: |
          if [ -f "test-channels-guide.xml" ]; then
            echo "✓ Channels file test passed!"
            ls -lh test-channels-guide.xml
          else
            echo "✗ Channels file test failed"
            exit 1
          fi
      
      - name: Upload result
        uses: actions/upload-artifact@v3
        with:
          name: test-channels-guide
          path: test-channels-guide.xml
          retention-days: 1
